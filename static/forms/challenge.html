<html>
<head>
	<script src="/js/jquery-3.6.0.min.js"></script>
</head>
<body>
	<div id="menu">
		<form autocomplete="off" action="javascript:void(0);">
            <input id="user.name" type="text" autocomplete="off" required />
			<button id="auth">Click me...</button>
        </form>
        <form method="post" action="/logout">
			<button id="logout">logout</button>
        </form>
	</div>
</body>
<script type="module">
	import init, {generate} from "/js/wasm.js";
	function auth() {
        let user = document.getElementById('user.name').value;
        if (user != '')
            stg1(user);
    }
    
    function stg1(user) {
		let payload = 'stage=1&user='+ user +'&signed=';
		$.post("/login",payload,"text")
            // Clean it later
            .always( () => { console.log("1: "+payload); })
            .done(
                resp => {
                    stg2(user,resp);
			    }
            )            
            .fail( 
                resp => {
                    // need to add a dialog box, if user is ok, call pageRedirect
                    if (resp.status === 303) {
                        alert("Sorry, we haven't met yet.")
                        pageRedirect(resp.responseText); 
                    }
                }
            );
	}
	
    function stg2(user,nonce) {
		init()
			.then( 
				() => { 
					let payload = 'stage=2&user='+ user +'&signed='+generate();
					$.post("/login",payload,"text")
                        // Clean it later
                        .always( () => { console.log("2: "+payload); })
						.done( 
							resp => {
                                alert("Welcome ! Here is your cookie, don't forget the milk and go on ~:)");
                                // Browser reject the redirection O_o
                                pageRedirect(resp.responseText); 
							}
						)
                        .fail(
                            resp => {
                                if (resp.status === 401)
                                    alert("Incorrect private key provided !");
                                else
                                    alert("Unknown error returned.");
                            }
                        );
				} 
			);
	}
    
    function pageRedirect(url) {
        $(location).attr("href", url);
    }
	
    document.getElementById('auth').addEventListener('click', auth, true);
</script>
</html>